---
title: "Weather events wich resulted in most population health and econimics damage"
author: "Alexandr Cherkashin"
date: "Wednesday, January 21, 2015"
output: html_document
---

##Synopsis
This project will address some basic questions about severe weather events:
       
        - Across the United States, which types of events are most harmful with respect to population health?
        - Across the United States, which types of events have the greatest economic consequences?

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage. The events in the database start in the year 1950 and end in November 2011.

We will find that...

##Data Processing
###Used r packages
For further analisys and data transformations will be used several r packages. 
Check that needed packages have been installed and install them if not:
```{r, message=FALSE}
list.of.packages <- c("ggplot2", "dplyr", "tidyr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
sapply(list.of.packages, require, quietly = TRUE, character.only = TRUE)

#remove unused variables
rm(list.of.packages)
rm(new.packages)
```

###Data source
The data for this project come in the form of a comma-separated-value file compressed via the bzip2 algorithm to reduce its size. It comes from course web site by this link: http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2

Download data unless it's alredy done:
```{r}
if (!file.exists("./data")) {dir.create("./data")}
if (!file.exists("./data/StormData.bz2")) {download.file("http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "./data/StormData.bz2", mode = "wb")}
```

###Data preparation
Extract and read the data
```{r, cache=TRUE}
con <- bzfile("./data/StormData.bz2", open="r")
data <- read.csv(con)
close(con)
rm(con)
```

Look at colum names:
```{r}
colnames(data)
```

For the purpose of this project we need only some, so get rid of others to make dataset smaller.
```{r, cache=TRUE}
data <- select(data, EVTYPE, 23:28)
```

According to [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) section 2.7:

>Estimates should be rounded to three significant digits, followed by an alphabetical character signifying the magnitude of the number, i.e., 1.55B for $1,550,000,000.  Alphabetical characters used to signify magnitude include “K” for thousands, “M” for >millions, and “B” for billions.
<...>
>If the dollar amount of damage is unknown, or not available, check the “no information available” box.

Lets look at PROPDMGEXP and CROPDMGEXP colums that contains these magnitude signifyers:
```{r}
table(data[data$PROPDMG!=0, "PROPDMGEXP"])
table(data[data$CROPDMG!=0, "CROPDMGEXP"])
```

For this analisys we'll assume that lower case characters means that capital ones do.
As we can see, there are several signifyers of unkown type like "h" or "?" but they have very small accurance when the corresponding DMG colums is not equal zero. There could different theryes but we will not do any bold assumtions and accrording to such a small occurance just drop the rows with them.
```{r}
#make all chars same size
data$PROPDMGEXP <- tolower(as.character(data$PROPDMGEXP))
data$CROPDMGEXP <- tolower(as.character(data$CROPDMGEXP))

#making multiplyer
data$PROPDMGEXP[data$PROPDMGEXP!="b" & data$PROPDMGEXP!="m" & data$PROPDMGEXP!="k"] <- NA
data$PROPDMGEXP[data$PROPDMGEXP=="b"] <- 1000000000
data$PROPDMGEXP[data$PROPDMGEXP=="m"] <- 1000000
data$PROPDMGEXP[data$PROPDMGEXP=="k"] <- 1000

data$CROPDMGEXP[data$CROPDMGEXP!="b" & data$CROPDMGEXP!="m" & data$CROPDMGEXP!="k"] <- NA
data$CROPDMGEXP[data$CROPDMGEXP=="b"] <- 1000000000
data$CROPDMGEXP[data$CROPDMGEXP=="m"] <- 1000000
data$CROPDMGEXP[data$CROPDMGEXP=="k"] <- 1000

#Multiply DMG columns
data$PROPDMG <- data$PROPDMG * as.numeric(data$PROPDMGEXP)
data$CROPDMG <- data$CROPDMG * as.numeric(data$CROPDMGEXP)
```

Now we will convert this dataset to narrow tidy form:
```{r}
data <- select(data, EVTYPE, FATALITIES, INJURIES, PROPDMG, CROPDMG)
data <- gather(data, DMGTYPE, VALUE, -EVTYPE, na.rm = TRUE)
```

There are 985 levels of EVTYPE factor. We will try to reduce the number of unique values
```{r}
data <- filter(data, !grepl("Summary", EVTYPE, ignore.case = TRUE))
data$EVTYPE <- toupper(as.character(data$EVTYPE))
data[grep("heat", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"
data[grep("warm", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"
data[grep("hot", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"
data[grep("HIGH TEMPER", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"
data[grep("HYPERTHERMIA", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"
data[grep("Record High", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heat"

data[grep("cold", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("cool", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("frost", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("HYPORTHERMIA", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("freez", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("frost", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("ice", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("icy", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("LOW TEMPER", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"
data[grep("RECORD LOW", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Cold"

data[grep("tornado", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Tornado"
data[grep("spout", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Tornado"

data[grep("swell", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High swells"
data[grep("surf", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High swells"
data[grep("wave", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High swells"
data[grep("ROUGH SEAS", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High swells"

data[grep("wind", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"
data[grep("hurricane", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"
data[grep("wnd", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"
data[grep("TYPHOON", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"
data[grep("tsunami", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"
data[grep("storm", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "High wind/hurricane"

data[grep("snow", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy snow"
data[grep("blizz", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy snow"
data[grep("wint", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy snow"

data[grep("flood", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Flood"
data[grep("FLD", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Flood"
data[grep("water", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Flood"
data[grep("stream", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Flood"
data[grep("tide", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Flood"

data[grep("rain", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy rain"
data[grep("SHOWER", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy rain"
data[grep("precipit", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Heavy rain"

data[grep("dry", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Drought"
data[grep("drought", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Drought"

data[grep("hail", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Hail"

data[grep("fog", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Fog"

data[grep("wet", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Wet"

data[grep("fire", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Wildfire"

data[grep("light", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Lightning"

data[grep("rip", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Rip current"

data[grep("avalanc", data$EVTYPE, ignore.case = TRUE), "EVTYPE"] <- "Avalanche"
```

All other values that a still in upper case with map to "Other" category. Group all types together.
```{r}
data$EVTYPE[data$EVTYPE == toupper(data$EVTYPE)] <- "Other"
data <- group_by(data, EVTYPE, DMGTYPE) %>% summarise(VALUE = sum(VALUE))
data <- mutate(data, QUESTION = factor(ifelse(DMGTYPE == "PROPDMG" | DMGTYPE == "CROPDMG", "Economic harm", "Health harm")))
data$EVTYPE <- factor(data$EVTYPE)
```
##Results